package com.malclean.admin.store;

import com.malclean.admin.store.exception.FileNotTransferedException;
import com.malclean.admin.store.exception.WrongUrlException;
import org.springframework.core.io.Resource;
import org.springframework.core.io.UrlResource;
import org.springframework.web.multipart.MultipartFile;

import java.io.File;
import java.io.IOException;
import java.net.MalformedURLException;
import java.util.UUID;

public class LocalStoreManager implements StoreManager{

    private String fileDir;

    public LocalStoreManager(String fileDir) {
        this.fileDir = fileDir;
    }

    @Override
    public String save(MultipartFile multipartFile) {
        String storeFileName = createStoreFileName(multipartFile.getOriginalFilename());
        String fullPath = fileDir + storeFileName;
        try{
            multipartFile.transferTo(new File(fullPath));
            return storeFileName;
        }
        catch (IOException ioException){
            throw new FileNotTransferedException(ioException);
        }
    }

    @Override
    public Resource getResource(String filename) {
        String fullPath = fileDir + filename;
        try {
            Resource urlResource = new UrlResource("file:" + fullPath);
            return urlResource;
        }
        catch(MalformedURLException e) {
            throw new WrongUrlException(e);
        }
    }

    private String createStoreFileName(String originalFilename){
        String ext = extractExt(originalFilename);
        String uuid = UUID.randomUUID().toString();
        return uuid + "." + ext;
    }

    private String extractExt(String originalFilename) {
        int pos = originalFilename.lastIndexOf(".");
        return originalFilename.substring(pos + 1);
    }
}
