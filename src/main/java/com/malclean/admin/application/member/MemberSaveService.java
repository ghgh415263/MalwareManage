package com.malclean.admin.application.member;

import com.malclean.admin.application.member.exceptions.WeakPasswordException;
import com.malclean.admin.application.member.requestdto.MemberSaveReq;
import com.malclean.admin.domain.member.*;
import com.malclean.admin.domain.member.PasswordEncoder;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@RequiredArgsConstructor
@Slf4j
@Service
public class MemberSaveService {

    private final MemberRepository memberRepository;
    private final MemberCheckService memberCheckService;
    private final PasswordEncoder passwordEncoder;
    private final PasswordMeter passwordMeter;

    @Transactional
    public void saveMember(MemberSaveReq memberSaveReq) {

        if (passwordMeter.isEnough(memberSaveReq.getPassword()))
            throw new WeakPasswordException();

        memberCheckService.checkDuplicateUsername(memberSaveReq.getUsername());

        String encodedPassword = passwordEncoder.hashPassword(memberSaveReq.getPassword());

        AuthorityType authorityType = AuthorityType.toEnumType(memberSaveReq.getAuthority());

        DepartmentType departmentType = DepartmentType.toEnumType(memberSaveReq.getDepartment());

        Member newMember = Member.builder()
                .username(memberSaveReq.getUsername())
                .password(encodedPassword)
                .authority(authorityType)
                .employeeId(memberSaveReq.getEmployeeId())
                .department(departmentType)
                .build();

        memberRepository.save(newMember);  //같은 유저네임의 insert가 중복될 경우, 그냥 시스템오류라고 띄워주는 것이 좋다.
    }
}
