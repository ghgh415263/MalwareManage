package com.malclean.admin.application.malware.malware;

import com.malclean.admin.application.common.exception.NotExistEntityException;
import com.malclean.admin.application.malware.malware.requestdto.MalwareEditRequest;
import com.malclean.admin.application.malware.malwarefile.MalwarefileSaveService;
import com.malclean.admin.domain.malware.malware.*;
import com.malclean.admin.domain.malware.malware.enums.RisknessType;
import com.malclean.admin.domain.malware.malware.enums.BehaviorType;
import com.malclean.admin.domain.malware.malware.enums.PurposeType;
import com.malclean.admin.domain.malware.malware.repository.MalwareMalwarefileBulkRepository;
import com.malclean.admin.domain.malware.malware.repository.MalwareMalwarefileRepository;
import com.malclean.admin.domain.malware.malware.repository.MalwareRepository;
import com.malclean.admin.domain.malware.malwarefile.Malwarefile;
import com.malclean.admin.domain.malware.malwarefile.MalwarefileRepository;
import com.malclean.admin.domain.malware.malwarefile.SignatureCreator;
import com.malclean.admin.domain.malware.malwarefile.SignatureMultipartfileMap;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import java.util.List;
import java.util.stream.Collectors;

@RequiredArgsConstructor
@Slf4j
@Service
public class MalwareEditService {

    private final MalwareRepository malwareRepository;

    private final MalwarefileRepository malwarefileRepository;

    private final MalwareMalwarefileRepository malwareMalwarefileRepository;

    private final SignatureCreator signatureCreator;

    private final MalwarefileSaveService malwarefileSaveService;

    private final MalwareMalwarefileBulkRepository malwareMalwareFileBulkRepository;

    private final MalwareValidationService malwareValidationService;

    @Transactional
    public void editMalware(Long malwareId, MalwareEditRequest malwareEditRequest, Long loginMemberId) {

        Malware malware = malwareRepository.findById(malwareId)
                .orElseThrow(NotExistEntityException::new);

        malwareValidationService.validateForEdit(malware, malwareEditRequest.getTitle(), malwareEditRequest.getNickname());

        malware.editTitle(malwareEditRequest.getTitle());
        malware.editContent(malwareEditRequest.getContent());
        malware.editNickname(malwareEditRequest.getNickname());
        RisknessType risknessType = RisknessType.toEnumType(malwareEditRequest.getRiskness());
        malware.editRisknessType(risknessType);
        malware.editDetectedTime(malwareEditRequest.getDetectedTime());
        malware.editResolvedTime(malwareEditRequest.getResolvedTime());

        List<MalwarePurpose> newMalwarePurposeList = malwareEditRequest.getPurposeList().stream()
                .map((stringPurpose) ->
                        new MalwarePurpose(malware, PurposeType.toEnumType(stringPurpose))
                ).collect(Collectors.toList());

        List<MalwareBehavior> newMalwareBehaviorList = malwareEditRequest.getBehaviorList().stream()
                .map((stringBehavior) ->
                        new MalwareBehavior(malware, BehaviorType.toEnumType(stringBehavior))
                ).collect(Collectors.toList());

        malware.replacePurposeList(newMalwarePurposeList);
        malware.replaceBehaviorList(newMalwareBehaviorList);

        malwareMalwarefileRepository.deleteAllByIds(malwareId, malwareEditRequest.getDeletedFileIdList());

        SignatureMultipartfileMap signatureMultipartfileMap =
                new SignatureMultipartfileMap(signatureCreator, malwareEditRequest.getMultipartFileList());

        malwarefileSaveService.saveMalwareFileList(signatureMultipartfileMap, loginMemberId);

        List<Malwarefile> malwarefiles = malwarefileRepository.findBySignatureIn(signatureMultipartfileMap.getSignatureList());

        List<MalwareMalwarefile> malwareMalwarefileList = malwarefiles.stream().map(
                malwareFile -> {
                    MultipartFile multipartFile = signatureMultipartfileMap.get(malwareFile.getSignature());
                    return MalwareMalwarefile.builder()
                            .malwarefile(malwareFile)
                            .malware(malware)
                            .filename(multipartFile.getOriginalFilename())
                            .build();
                }).collect(Collectors.toList());

        malwareMalwareFileBulkRepository.saveAll(malwareMalwarefileList, loginMemberId);
    }
}
