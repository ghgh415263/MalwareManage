package com.malclean.admin.application.malware.malwarefile;

import com.malclean.admin.domain.malware.malwarefile.*;
import com.malclean.admin.domain.malware.malwarefile.service.StoreManager;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.stream.Collectors;
import java.util.stream.Stream;

@RequiredArgsConstructor
@Slf4j
@Service
public class MalwareFileSaveService {

    private final MalwarefileRepository malwarefileRepository;

    private final StoreManager storeManager;

    private final MalwareFileBulkRepository malwareFileBulkRepository;

    @Transactional
    public List<Malwarefile> saveMalwareFileList(SignatureMultipartfileMap signatureMultipartfileMap, Long loginMemberId) {

        List<Malwarefile> savedMalwareFileList = malwarefileRepository.findBySignatureIn(signatureMultipartfileMap.getSignatureList());  //이미 저장된 같은 파일들을 찾는다.

        List<String> savedSignature = savedMalwareFileList.stream()
                .map(malwarefile -> malwarefile.getSignature())
                .collect(Collectors.toList());

        List<String> newSignatures = signatureMultipartfileMap.getOtherSignatures(savedSignature);

        List<Malwarefile> newMalwareFileList = newSignatures.stream()
                .map(newSignature -> {
                    String storeFilename = storeManager.save(signatureMultipartfileMap.get(newSignature));
                    Malwarefile malwareFile = Malwarefile.builder()
                            .signature(newSignature)
                            .storeFilename(storeFilename)
                            .build();
                    return malwareFile;
                }).collect(Collectors.toList());

        malwareFileBulkRepository.saveAll(newMalwareFileList, loginMemberId);

        List<Malwarefile> malwareFileList = Stream.of(savedMalwareFileList, newMalwareFileList)
                .flatMap(x -> x.stream())
                .collect(Collectors.toList());

        return malwareFileList;
    }
}