package com.malclean.admin.service.malware;

import com.malclean.admin.controller.malware.MalwareSaveDto;
import com.malclean.admin.entity.*;
import com.malclean.admin.enumtype.BehaviorType;
import com.malclean.admin.enumtype.PurposeType;
import com.malclean.admin.enumtype.RisknessType;
import com.malclean.admin.repository.MalwareRepository;
import com.malclean.admin.store.MalwareFileLocalStore;
import com.malclean.admin.store.StoreManager;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.CollectionUtils;
import org.springframework.web.multipart.MultipartFile;

import java.util.List;

@RequiredArgsConstructor
@Slf4j
@Service
public class MalwareSaveService {

    private final MalwareRepository malwareRepository;

    private final StoreManager malwareFileLocalStore;

    @Transactional
    public Malware saveMalware(MalwareSaveDto malwareSaveDto, Member loginMember) {


        Malware malware = Malware.builder()
                .poster(loginMember)
                .title(malwareSaveDto.getTitle())
                .content(malwareSaveDto.getContent())
                .nickname(malwareSaveDto.getNickname())
                .riskness(RisknessType.toEnumType(malwareSaveDto.getRiskness()))
                .detectedTime(malwareSaveDto.getDetectedTime())
                .resolvedTime(malwareSaveDto.getResolvedTime())
                .build();



        List<String> purposeList = malwareSaveDto.getPurposeList();

        if ( !CollectionUtils.isEmpty(purposeList) ) {
            purposeList.stream()
                    .map(purpose -> {

                        MalwarePurpose malwarePurpose = MalwarePurpose.builder()
                                .malware(malware)
                                .purposeType(PurposeType.toEnumType(purpose))
                                .build();

                        malware.addPurpose(malwarePurpose);

                        return null;
                    });
        }


        List<String> behaviorList = malwareSaveDto.getBehaviorList();

        if ( !CollectionUtils.isEmpty(behaviorList) ) {
            behaviorList.stream()
                    .map(behavior -> {

                        MalwareBehavior malwareBehavior = MalwareBehavior.builder()
                                .malware(malware)
                                .behaviorType(BehaviorType.toEnumType(behavior))
                                .build();

                        malware.addBehavior(malwareBehavior);

                        return null;
                    });
        }


        List<MultipartFile> multipartFileList = malwareSaveDto.getMultipartFileList();

        if ( !CollectionUtils.isEmpty(multipartFileList) ) {
            multipartFileList.stream()
                    .map(multipartFile -> {

                        MalwareFile malwareFile = MalwareFile.builder()
                                .uploader(loginMember)
                                .malware(malware)
                                .signature("")
                                .storeFilename("")
                                .filename("")
                                .build();

                        malware.addMalwareFile(malwareFile);

                        return null;
            });
        }

        malwareRepository.save(malware);
        return malware;
    }
}
