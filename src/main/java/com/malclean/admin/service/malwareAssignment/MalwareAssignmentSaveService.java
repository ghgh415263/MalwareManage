package com.malclean.admin.service.malwareAssignment;

import com.malclean.admin.entity.AssignmentAttachment;
import com.malclean.admin.entity.MalwareAssignment;
import com.malclean.admin.entity.Member;
import com.malclean.admin.entity.malware.Malware;
import com.malclean.admin.repository.AssignmentAttachmentRepository;
import com.malclean.admin.repository.malware.MalwareRepository;
import com.malclean.admin.repository.malwareAssignment.MalwareAssignmentRepository;
import com.malclean.admin.repository.member.MemberRepository;
import com.malclean.admin.store.LocalStoreManager;
import com.malclean.admin.store.LocalStorePath;
import com.malclean.admin.store.StoreManager;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

@RequiredArgsConstructor
@Slf4j
@Service
public class MalwareAssignmentSaveService {

    private final MalwareRepository malwareRepository;

    private final MalwareAssignmentRepository malwareAssignmentRepository;

    private final MemberRepository memberRepository;

    private final AssignmentAttachmentRepository assignmentAttachmentRepository;

    private final StoreManager localStoreManager = new LocalStoreManager(LocalStorePath.malwareAssignmentAttatchmentDir);

    @Transactional
    public Long saveMalwareAssignment(Long malwareId, MalwareAssignmentSaveDto malwareAssignmentSaveDto, String sessionUsername){
        Member sessionMember = memberRepository.findByUsername(sessionUsername)
                .orElseThrow();

        Member assignee = memberRepository.findById(malwareAssignmentSaveDto.getAssigneeId())
                .orElseThrow();

        Malware Malware = malwareRepository.findById(malwareId)
                .orElseThrow();

        MalwareAssignment malwareAssignment = MalwareAssignment.builder()
                .assigner(sessionMember)
                .assignee(assignee)
                .malware(Malware)
                .title(malwareAssignmentSaveDto.getTitle())
                .content(malwareAssignmentSaveDto.getContent())
                .assignmentStatus(malwareAssignmentSaveDto.getAssignmentStatusType())
                .estimatedTime(malwareAssignmentSaveDto.getEstimatedTime())
                .build();
        MalwareAssignment savedMalwareAssignment = malwareAssignmentRepository.save(malwareAssignment);

        malwareAssignmentSaveDto.getMultipartFileList().stream()
                .forEach(multipartFile -> {
                    String storeFilename = localStoreManager.save(multipartFile);
                    AssignmentAttachment assignmentAttachment = AssignmentAttachment.builder()
                            .malwareAssignment(malwareAssignment)
                            .uploader(sessionMember)
                            .filename(multipartFile.getOriginalFilename())
                            .storeFilename(storeFilename)
                            .build();
                    assignmentAttachmentRepository.save(assignmentAttachment);
                });

        return savedMalwareAssignment.getId();
    }
}
