<!DOCTYPE html>
<html th:replace="~{layout/layout :: layout(~{::title}, ~{::section})}" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>analysis</title>
</head>
<body>

<section>
    <div>
        <div>모델</div>
        <select id="model-select" class="form-control">
            <option VALUE="">선택</option>
            <option th:each="analysisModel : ${analysisModelListRes}"
                    th:value="${analysisModel.id}"
                    th:text="${analysisModel.name}">
            </option>
        </select>
        <button class="btn btn-outline-success analyze-btn">api 분석</button>
    </div>
    <div>
        <canvas id="myChart"/>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const $myChart = document.getElementById('myChart');

        $(document).on("click", ".analyze-btn", function () {

            const malwareFileId = window.location.pathname.split("/").at(2);
            const modelId = document.getElementById('model-select').value;
            let url = '/malwarefiles/' + malwareFileId + '/analysis-models/' + modelId +'/analyze';

            let options = {
                method: 'GET',
                mode: 'cors',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json;charset=UTF-8'
                },
            }

            fetch(url, options)
                .then((response) => {
                    if (response.ok) {
                        return response.json()
                    }
                })
                .then(result => {
                    console.log(result)
                    new Chart($myChart, {
                        type: 'bar',
                        data: {
                            labels: result.outputList.map(row => row.className),
                            datasets: [{
                                label: 'percent',
                                data: result.outputList.map(row => row.probability),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    suggestedMax: 1
                                },
                            }
                        }
                    });
                })
        });
    </script>
</section>

</body>
</html>