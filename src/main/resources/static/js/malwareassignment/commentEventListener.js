import { getCommentList } from './GetCommentList.js';
import { postComment } from './PostComment.js';
import { DeleteComment } from "./DeleteComment.js";
import { PatchComment } from "./PatchComment.js";
import { EditFormComment } from "./EditFormComment.js";
import { makeCommentTag } from "./makeCommentTag.js"
import { makePaginationBar } from "../makePaginationBar.js";
import { pagnationPage } from "../pagnationPage.js";

const reloadCommentList = (page) => {
    getCommentList(page)
        .then(result => {
            $('.list-group').empty();
            result.content.forEach(comment => {
                const commentTag = makeCommentTag(comment);
                $('.list-group').append(commentTag);
            })
            let paginationBarTag = makePaginationBar(result.customPageable);
            document.querySelector('.paging').replaceChildren(paginationBarTag);
        })
        .then(() => {
            pagnationPage()
        })
}

window.onload  = () => {
    reloadCommentList(1)
}

document.getElementById('comment-submit-btn')
    .addEventListener('click', (event) => {
        postComment().then((response) => {
            if (response.ok) {
                reloadCommentList(1)
            }
        })
    })

$(document).on("click", ".comment-delete-btn", function (event) {
    const $li = event.target.closest('li');
    const id = $li.dataset.id;
    DeleteComment(id).then((response) => {
        if (response.ok) {
            reloadCommentList(1)
        }
    })
});

$(document).on("click", ".comment-patchForm-btn", function (event) {

    const $li = event.target.closest('li');
    const id = $li.dataset.id;

    const $textarea = document.createElement('textarea');
    $textarea.setAttribute('id', 'comment-updatedContent');

    EditFormComment(id)
        .then(response => {
            if (response.ok) {
                return response.json()
            }
        })
        .then(result => {
            $textarea.innerText = result.content
        })

    const $updateButton = document.createElement('button');
    $updateButton.setAttribute('class', 'comment-patch-btn');
    $updateButton.innerText = "수정";

    $li.innerHTML = "";
    $li.append($textarea, $updateButton);
});


$(document).on("click", ".comment-patch-btn", function (event) {
    const $li = event.target.closest('li');
    const id = $li.dataset.id;
    PatchComment(id).then((response) => {
        if (response.ok) {
            $(".list-group li").each(function(){
                $(this).remove();
            });
            getCommentList(null)
        }
    })
});