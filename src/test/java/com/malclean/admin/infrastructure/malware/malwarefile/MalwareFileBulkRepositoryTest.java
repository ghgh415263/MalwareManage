package com.malclean.admin.infrastructure.malware.malwarefile;

import com.malclean.admin.TestAuditingConfig;
import com.malclean.admin.domain.malware.malwarefile.MalwareFileBulkRepository;
import com.malclean.admin.domain.malware.malwarefile.Malwarefile;
import com.malclean.admin.helper.TestMalwarefileFactory;
import com.malclean.admin.infrastructure.malware.malwarefile.MalwareFileBulkRepositoryImpl;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.orm.jpa.DataJpaTest;
import org.springframework.boot.test.autoconfigure.orm.jpa.TestEntityManager;
import org.springframework.context.annotation.Import;
import org.springframework.jdbc.core.JdbcTemplate;

import java.util.List;

import static org.assertj.core.api.AssertionsForClassTypes.assertThat;

@Slf4j
@DataJpaTest
@Import(TestAuditingConfig.class)
public class MalwareFileBulkRepositoryTest {

    @Autowired
    private TestEntityManager testEntityManager;

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private MalwareFileBulkRepository malwareFileBulkRepository;

    @BeforeEach
    public void beforeEach() {
        malwareFileBulkRepository = new MalwareFileBulkRepositoryImpl(jdbcTemplate);
    }

    @Test
    void 저장() {
        Malwarefile malwarefile1 = TestMalwarefileFactory
                .createMalwarefile("signature1", "storeFilename1.jpg");
        Malwarefile malwarefile2 = TestMalwarefileFactory
                .createMalwarefile("signature2", "storeFilename2.jpg");

        malwareFileBulkRepository.saveAll(List.of(malwarefile1,malwarefile2), 1l);

        Malwarefile findedMalwarefile1 = testEntityManager.find(Malwarefile.class, 1l);
        Malwarefile findedMalwarefile2 = testEntityManager.find(Malwarefile.class, 2l);
        assertThat(findedMalwarefile1.getSignature()).isEqualTo("signature1");
        assertThat(findedMalwarefile2.getSignature()).isEqualTo("signature2");
    }
}
